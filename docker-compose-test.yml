version: '2'
services:
  api-falcon:
    restart: always
    build: api-falcon
    volumes:
      - ./api-falcon/src/:/project/
    command: gunicorn -b 0.0.0.0:8000 --access-logfile - --error-logfile - api
    ports:
      - 8000:8000
    links:
      - mongo:mongo
    env_file:
      - config.env
    depends_on:
      - mongo
  mongo:
    image: mongo:rc-xenial
    restart: always
    ports:
      - 27017:27017
  mongo-express:
    image: mongo-express
    restart: always
    ports:
      - 8081:8081
    depends_on:
      - mongo

  listener:
    build: listener
    # restart: always
    command: python3 main.py
    volumes:
      - ./listener/src/:/project
    environment:
     - PYTHONUNBUFFERED=1
     - LOAN_MANAGER_ADDRESS=0xE662674F70Fc55c1A2Dc2d15ed2C51E898091447
     - DEBT_ENGINE_ADDRESS=0x2B7371128D88957EC1c2Cd7BE078e5708Ff41Ca6
     - INSTALLMENTS_ADDRESS=0x0396B3E4feBb28c9Fe54D0236bE5c7D92d78B34b
     - COLLATERAL_ADDRESS=0xd3Ab4ebFeE953F7Ec6E19531da132CDb05B7C449
     - URL_NODE=http://ganachecli:8545
     - START_SYNC=-1
     - SENTRY_DSN=
     - MONGO_DB=rcn
     - MONGO_HOST=mongo
    depends_on:
      - mongo
    links:
      - mongo:mongo
      - ganachecli:ganachecli

  ganachecli:
    image: trufflesuite/ganache-cli:latest
    command: ganache-cli -h 0.0.0.0 -m "delay practice wall dismiss amount tackle energy annual wrap digital arrive since"
    stdin_open: true
    tty: true
    ports:
      - 8545:8545

  test-truffle:
    build:
      context: ./tests/truffle
    command: bash -c "npm install && truffle test "
    stdin_open: true
    tty: true
    environment:
     - BASE_URL=http://api-falcon:8000/v4/
    ports:
      - 8080:8080
    volumes:
      - ./tests/LoansLifeCycleTests:/tests
    working_dir: /tests
    links:
      - ganachecli:ganachecli
      - api-falcon:api-falcon
